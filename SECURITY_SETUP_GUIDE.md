# üîê SECURITY SETUP GUIDE
**SS Foto Web - Production Security Implementation**

---

## üìã TABLE OF CONTENTS
1. [Overview](#overview)
2. [Environment Setup](#environment-setup)
3. [Supabase Configuration](#supabase-configuration)
4. [Rate Limiting Setup (Optional)](#rate-limiting-setup)
5. [Testing](#testing)
6. [Deployment Checklist](#deployment-checklist)

---

## üéØ OVERVIEW

This guide walks you through implementing the security fixes for SS Foto Web:

‚úÖ **Implemented (by AI):**
- Secure Upload API with server-side validation
- Rate limiting (in-memory fallback + Upstash ready)
- Production-safe logger
- Error boundaries
- Loading states

‚ö†Ô∏è **Manual Setup Required:**
- Supabase SERVICE_ROLE_KEY
- Make Storage Bucket Private
- (Optional) Upstash Redis for production rate limiting

---

## üîß ENVIRONMENT SETUP

### Step 1: Create `.env.local` File

```bash
# Copy the template
cp .env.local.example .env.local
```

### Step 2: Fill in Supabase Credentials

1. **Open Supabase Dashboard:** https://supabase.com/dashboard
2. **Navigate to:** Your Project ‚Üí Settings ‚Üí API
3. **Copy these values:**

```env
# Add to .env.local:
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

‚ö†Ô∏è **CRITICAL:** 
- `SERVICE_ROLE_KEY` is SECRET - NEVER commit to git or expose to client!
- Only use in API routes (server-side)

### Step 3: Restart Dev Server

```bash
# Stop current server (Ctrl+C)
npm run dev
```

---

## üóÑÔ∏è SUPABASE CONFIGURATION

### Part A: Make Storage Bucket PRIVATE

**Current Status:** `pas-foto-uploads` bucket is PUBLIC (security risk!)

**Fix Steps:**

1. **Open Supabase Dashboard:** Storage ‚Üí `pas-foto-uploads`
2. **Click Settings (gear icon)**
3. **Toggle "Public" to OFF**
4. **Save Changes**

### Part B: Update RLS Policies

1. **Navigate to:** Storage ‚Üí Policies
2. **Delete ALL existing policies** for `pas-foto-uploads`
3. **Run this SQL** (SQL Editor ‚Üí New Query):

```sql
-- Policy 1: Allow service role to do everything
CREATE POLICY "Allow service role full access"
ON storage.objects FOR ALL
TO service_role
USING (bucket_id = 'pas-foto-uploads')
WITH CHECK (bucket_id = 'pas-foto-uploads');

-- Policy 2: Allow authenticated users to upload
CREATE POLICY "Allow authenticated uploads"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'pas-foto-uploads');
```

4. **Click "Run"**

**Why this works:**
- Service role (API route) can do everything
- Regular users can only upload (via API route)
- Files are private by default
- Signed URLs generated by API have expiration

---

## ‚ö° RATE LIMITING SETUP (Optional but Recommended)

**Current Status:** Using in-memory fallback (resets on server restart)

**For Production:** Set up Upstash Redis (free tier available)

### Step 1: Create Upstash Account

1. **Sign up:** https://upstash.com/
2. **Create Redis Database:**
   - Click "Create Database"
   - Choose region closest to your users
   - Select "Free" tier

### Step 2: Get Credentials

1. **Click on your database**
2. **Copy:**
   - `UPSTASH_REDIS_REST_URL`
   - `UPSTASH_REDIS_REST_TOKEN`

### Step 3: Add to .env.local

```env
UPSTASH_REDIS_REST_URL=https://your-redis.upstash.io
UPSTASH_REDIS_REST_TOKEN=your_token_here
```

### Step 4: Install Dependencies

```bash
npm install @upstash/ratelimit @upstash/redis
```

### Step 5: Uncomment Code

**File:** `src/lib/rateLimiter.ts`

Find this section (around line 50) and **UNCOMMENT**:

```typescript
// ============ UNCOMMENT THIS SECTION ============
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL!,
  token: process.env.UPSTASH_REDIS_REST_TOKEN!,
});

const upstashLimiter = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(5, "15 m"),
  analytics: true,
  prefix: "ratelimit:upload",
});

const checkRateLimitUpstash = async (identifier: string): Promise<RateLimitResult> => {
  const { success, limit, reset, remaining } = await upstashLimiter.limit(identifier);
  return { success, limit, remaining, reset };
};
// ================================================
```

Then find this line (around line 70) and **UPDATE**:

```typescript
// BEFORE:
if (isUpstashConfigured()) {
  // return await checkRateLimitUpstash(identifier);
  console.warn('‚ö†Ô∏è Upstash configured but code commented out.');
}

// AFTER:
if (isUpstashConfigured()) {
  return await checkRateLimitUpstash(identifier);
}
```

### Step 6: Restart & Test

```bash
npm run dev
```

---

## üß™ TESTING

### Test 1: Basic Upload

1. **Navigate to:** http://localhost:3000/upload/pas-foto
2. **Upload a valid photo** (JPG/PNG, <5MB)
3. **Fill in name & WhatsApp**
4. **Click "Pesan Sekarang"**
5. **Expected:**
   - ‚úÖ Success message
   - ‚úÖ Redirects to WhatsApp
   - ‚úÖ File uploaded to Supabase
   - ‚úÖ Order saved to database

### Test 2: File Validation

**A. Large File Test:**
- Upload a file >5MB
- **Expected:** Error message "File terlalu besar"

**B. Invalid Format Test:**
- Try uploading a .pdf or .exe file
- **Expected:** Error message "Format file tidak valid"

### Test 3: Rate Limiting

1. **Upload 6 photos rapidly** (within 1 minute)
2. **6th upload should fail** with:
   - Status: 429 Too Many Requests
   - Message: "Terlalu banyak request..."
3. **Wait 15 minutes**, try again
4. **Should work** (rate limit reset)

### Test 4: Private Storage

1. **Upload a photo successfully**
2. **Copy the signed URL** from WhatsApp message
3. **Open in browser** ‚Üí Should work
4. **Wait 24 hours + 1 minute**
5. **Try the same URL** ‚Üí Should be expired/access denied

### Test 5: Error Boundaries

**Trigger Error Manually:**

```typescript
// Temporarily add to upload page:
throw new Error('Test error boundary');
```

- **Expected:** Error page displays with "Coba Lagi" button
- Remove test error after verification

---

## üöÄ DEPLOYMENT CHECKLIST

### Before Deploying to Production:

#### ‚úÖ Environment Variables

```bash
# Vercel/Netlify/etc - Add these in Dashboard:
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...         # ‚ö†Ô∏è MARK AS SECRET!
UPSTASH_REDIS_REST_URL=...            # (if using Upstash)
UPSTASH_REDIS_REST_TOKEN=...          # (if using Upstash)
```

#### ‚úÖ Supabase Storage

- [ ] Bucket `pas-foto-uploads` is PRIVATE
- [ ] RLS policies are configured
- [ ] Test signed URL expiration

#### ‚úÖ Rate Limiting

- [ ] Upstash Redis configured (recommended for production)
- [ ] Test rate limits in production environment

#### ‚úÖ Security

- [ ] No console.log in production build
- [ ] `.env.local` NOT in git (check `.gitignore`)
- [ ] SERVICE_ROLE_KEY never exposed to client

#### ‚úÖ Error Handling

- [ ] Error boundaries tested
- [ ] Loading states work
- [ ] User-friendly error messages

#### ‚úÖ Performance

- [ ] Images optimized
- [ ] Bundle size checked: `npm run build`
- [ ] Lighthouse score >90

---

## üÜò TROUBLESHOOTING

### Issue: "Environment variables not loading"

**Solution:**
```bash
# 1. Stop server (Ctrl+C)
# 2. Clear cache
rm -rf .next
# 3. Restart
npm run dev
```

### Issue: "Upload Error: Bucket not found"

**Solution:**
- Check Supabase bucket name is exactly `pas-foto-uploads`
- Verify credentials in `.env.local`
- Restart server

### Issue: "Database Error: RLS policy violation"

**Solution:**
- Review RLS policies in Supabase Dashboard
- Ensure service role has full access
- Check SQL policy code above

### Issue: "Rate limit not working"

**Solution:**
- If using in-memory: Normal (resets on restart)
- If using Upstash: Check credentials and uncommented code
- Test with `curl` to API endpoint directly

---

## üìû SUPPORT

**Documentation:**
- Supabase: https://supabase.com/docs
- Upstash: https://docs.upstash.com
- Next.js: https://nextjs.org/docs

**Questions?**
- Check console for error messages
- Review this guide step-by-step
- Test in development before production

---

**Last Updated:** December 2024  
**Version:** 1.0

